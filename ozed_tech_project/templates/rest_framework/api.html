{% load rest_framework %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Ozed Tech API{% endblock %}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar h1 {
            font-size: 1.5em;
        }

        .navbar a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            background: rgba(255,255,255,0.2);
            margin-left: 10px;
        }

        .navbar a:hover {
            background: rgba(255,255,255,0.3);
        }

        .content {
            padding: 30px;
        }

        .breadcrumb {
            background: #f8f9fa;
            padding: 15px 30px;
            border-bottom: 1px solid #dee2e6;
        }

        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .request-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .response-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
        }

        .form-section {
            background: white;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            margin-top: 20px;
        }

        .form-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        button, input[type="submit"] {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }

        button:hover, input[type="submit"]:hover {
            background: #764ba2;
        }

        textarea, input[type="text"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin-bottom: 10px;
        }

        .method-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9em;
            margin-right: 10px;
        }

        .method-get { background: #28a745; color: white; }
        .method-post { background: #007bff; color: white; }
        .method-put { background: #ffc107; color: #333; }
        .method-patch { background: #17a2b8; color: white; }
        .method-delete { background: #dc3545; color: white; }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 5px;
            overflow: hidden;
        }

        .data-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            word-break: break-word;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table a {
            color: #667eea;
            text-decoration: none;
        }

        .data-table a:hover {
            text-decoration: underline;
        }

        .card-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .data-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .data-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .data-card h4 {
            color: #667eea;
            margin-bottom: 10px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .data-card .field {
            margin: 8px 0;
            padding: 5px 0;
        }

        .data-card .field-label {
            font-weight: 600;
            color: #666;
            display: inline-block;
            min-width: 120px;
        }

        .data-card .field-value {
            color: #333;
        }

        .pagination-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pagination-buttons {
            display: flex;
            gap: 10px;
        }

        .view-toggle {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="navbar">
            <h1><a href="/api/" style="color: white; text-decoration: none;">Ozed Tech API</a></h1>
            <div>
                <a href="/api/">Home</a>
                <a href="/admin/">Admin</a>
                {% if user.is_authenticated %}
                    <a href="{% url 'rest_framework:logout' %}">Logout ({{ user.username }})</a>
                {% else %}
                    <a href="{% url 'rest_framework:login' %}">Login</a>
                {% endif %}
            </div>
        </div>

        <div class="breadcrumb">
            {% block breadcrumbs %}
                <a href="/api/">API</a>
                {% if request.path != '/api/' %}
                    &raquo; {{ name }}
                {% endif %}
            {% endblock %}
        </div>

        <div class="content">
            <div class="request-info">
                <span class="method-badge method-{{ request.method|lower }}">{{ request.method }}</span>
                <strong>{{ request.path }}</strong>
                {% if user.is_authenticated %}
                    <span style="float: right;">‚úì Authenticated as <strong>{{ user.username }}</strong></span>
                {% endif %}
            </div>

            {% if description %}
                <div style="margin-bottom: 20px; color: #666;">
                    {{ description }}
                </div>
            {% endif %}

            <!-- Export Buttons -->
            <div class="export-buttons" style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <script>
                    // Detect which endpoint we're on and show appropriate export buttons
                    const path = window.location.pathname;
                    const exportButtons = [];

                    if (path.includes('/inventory/items') && !path.match(/\/\d+\//)) {
                        // Items list view
                        exportButtons.push({
                            label: 'üì• Export CSV',
                            url: path.replace(/\/$/, '') + '/export_csv/',
                            color: '#28a745'
                        });
                        exportButtons.push({
                            label: 'üìä Export Excel',
                            url: path.replace(/\/$/, '') + '/export_excel/',
                            color: '#17a2b8'
                        });
                    } else if (path.includes('/sales-orders') && !path.match(/\/\d+\//)) {
                        // Sales orders list view
                        exportButtons.push({
                            label: 'üì• Export CSV',
                            url: path.replace(/\/$/, '') + '/export_csv/',
                            color: '#28a745'
                        });
                        exportButtons.push({
                            label: 'üìä Export Excel',
                            url: path.replace(/\/$/, '') + '/export_excel/',
                            color: '#17a2b8'
                        });
                    } else if (path.match(/\/sales-orders\/\d+\/$/)) {
                        // Sales order detail view
                        exportButtons.push({
                            label: 'üìÑ Generate PDF Invoice',
                            url: path.replace(/\/$/, '') + '/generate_invoice/',
                            color: '#dc3545'
                        });
                    } else if (path.includes('/crm/customers') && !path.match(/\/\d+\//)) {
                        // Customers list view
                        exportButtons.push({
                            label: 'üì• Export CSV',
                            url: path.replace(/\/$/, '') + '/export_csv/',
                            color: '#28a745'
                        });
                        exportButtons.push({
                            label: 'üìä Export Excel',
                            url: path.replace(/\/$/, '') + '/export_excel/',
                            color: '#17a2b8'
                        });
                    }

                    // Render export buttons
                    if (exportButtons.length > 0) {
                        const container = document.querySelector('.export-buttons');
                        exportButtons.forEach(btn => {
                            const a = document.createElement('a');
                            a.href = btn.url;
                            a.textContent = btn.label;
                            a.style.cssText = `
                                background: ${btn.color};
                                color: white;
                                padding: 10px 20px;
                                border-radius: 5px;
                                text-decoration: none;
                                font-weight: 500;
                                display: inline-block;
                                transition: all 0.3s;
                            `;
                            a.onmouseover = () => a.style.opacity = '0.8';
                            a.onmouseout = () => a.style.opacity = '1';
                            container.appendChild(a);
                        });
                    } else {
                        // Hide container if no buttons
                        document.querySelector('.export-buttons').style.display = 'none';
                    }
                </script>
            </div>

            <div class="response-info">
                <h3>Response</h3>
                <div style="margin-bottom: 15px;">
                    <button onclick="toggleView('table')" style="margin-right: 10px;">üìä Table View</button>
                    <button onclick="toggleView('json')">üìÑ JSON View</button>
                </div>

                <div id="table-view" style="display: block;">
                    <!-- Table view will be populated by JavaScript -->
                </div>

                <div id="json-view" style="display: none;">
                    {% block content %}
                        {{ content }}
                    {% endblock %}
                </div>
            </div>

            {% if 'GET' in allowed_methods and post_form or put_form or patch_form or delete_form %}
                <div class="form-section">
                    <h3>Make a Request</h3>
                    {% if post_form %}
                        <h4>POST</h4>
                        {{ post_form }}
                    {% endif %}
                    {% if put_form %}
                        <h4>PUT</h4>
                        {{ put_form }}
                    {% endif %}
                    {% if patch_form %}
                        <h4>PATCH</h4>
                        {{ patch_form }}
                    {% endif %}
                    {% if delete_form %}
                        <h4>DELETE</h4>
                        {{ delete_form }}
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        let currentView = 'table';
        let responseData = null;

        // Toggle between table and JSON view
        function toggleView(view) {
            currentView = view;
            document.getElementById('table-view').style.display = view === 'table' ? 'block' : 'none';
            document.getElementById('json-view').style.display = view === 'json' ? 'block' : 'none';
        }

        // Parse JSON from various sources
        function parseResponse() {
            // Try to get from embedded script tag
            const dataScript = document.getElementById('response-data');
            if (dataScript) {
                try {
                    return JSON.parse(dataScript.textContent);
                } catch (e) {
                    console.error('Failed to parse from script:', e);
                }
            }

            // Try to get from pre tag
            const preElement = document.querySelector('#json-view pre');
            if (preElement) {
                try {
                    const text = preElement.textContent;
                    return JSON.parse(text);
                } catch (e) {
                    console.error('Failed to parse from pre:', e);
                }
            }

            // Try to fetch current URL with JSON format
            const url = new URL(window.location.href);
            url.searchParams.set('format', 'json');

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    responseData = data;
                    renderDataFromObject(data);
                })
                .catch(e => {
                    console.error('Failed to fetch JSON:', e);
                    document.getElementById('table-view').innerHTML =
                        '<p style="text-align: center; color: #999; padding: 20px;">Unable to load data. <a href="?format=json">View JSON</a></p>';
                });

            return null;
        }

        // Format value for display
        function formatValue(value) {
            if (value === null || value === undefined) {
                return '<span style="color: #999;">null</span>';
            }
            if (typeof value === 'boolean') {
                return value ? '<span class="badge badge-success">true</span>' : '<span class="badge badge-danger">false</span>';
            }
            if (typeof value === 'object') {
                return JSON.stringify(value);
            }
            if (typeof value === 'string' && value.startsWith('http')) {
                return `<a href="${value}" target="_blank">${value}</a>`;
            }
            return value;
        }

        // Create table from array of objects
        function createTable(data) {
            if (!Array.isArray(data) || data.length === 0) {
                return '<p style="text-align: center; color: #999; padding: 20px;">No data available</p>';
            }

            const keys = Object.keys(data[0]);
            let html = '<table class="data-table">';

            // Header
            html += '<thead><tr>';
            keys.forEach(key => {
                html += `<th>${key.replace(/_/g, ' ').toUpperCase()}</th>`;
            });
            html += '</tr></thead>';

            // Body
            html += '<tbody>';
            data.forEach(item => {
                html += '<tr>';
                keys.forEach(key => {
                    html += `<td>${formatValue(item[key])}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';

            return html;
        }

        // Create card view for single object
        function createCard(data) {
            if (typeof data !== 'object' || data === null) {
                return '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
            }

            let html = '<div class="data-card">';
            html += '<h4>Details</h4>';

            Object.keys(data).forEach(key => {
                if (key !== 'results' && key !== 'next' && key !== 'previous') {
                    const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    html += `<div class="field">`;
                    html += `<span class="field-label">${label}:</span>`;
                    html += `<span class="field-value">${formatValue(data[key])}</span>`;
                    html += `</div>`;
                }
            });

            html += '</div>';
            return html;
        }

        // Render data from object
        function renderDataFromObject(data) {
            if (!data) {
                document.getElementById('table-view').innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No data available</p>';
                return;
            }

            responseData = data;
            let html = '';

            // Check if paginated response
            if (data.results && Array.isArray(data.results)) {
                // Pagination info
                html += '<div class="pagination-info">';
                html += `<div><strong>Total:</strong> ${data.count || data.results.length} items</div>`;
                html += '<div class="pagination-buttons">';
                if (data.previous) {
                    html += `<a href="${data.previous}"><button>‚Üê Previous</button></a>`;
                } else {
                    html += `<button disabled style="opacity: 0.5;">‚Üê Previous</button>`;
                }
                if (data.next) {
                    html += `<a href="${data.next}"><button>Next ‚Üí</button></a>`;
                } else {
                    html += `<button disabled style="opacity: 0.5;">Next ‚Üí</button>`;
                }
                html += '</div></div>';

                // Table
                html += createTable(data.results);
            } else if (Array.isArray(data)) {
                // Array response
                html += createTable(data);
            } else {
                // Single object response
                html += createCard(data);
            }

            document.getElementById('table-view').innerHTML = html;
        }

        // Render the data
        function renderData() {
            const data = parseResponse();
            if (data) {
                renderDataFromObject(data);
            }
            // If data is null, parseResponse() will handle fetching it
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            renderData();
        });
    </script>
</body>
</html>
